<p class="text-center">Para que se pueda usar el protocolo SCS a los datos subidos es necesario que al menos se seleccionen tres columnas, dos con los datos de las posiciones, es decir, RA (con UCD pos.eq.ra;meta.main), DEC (con UCD pos.eq.dec;meta.main) y otra columna que actue como un identificador (con UCD meta.id;meta.main)</p>

<br />

<div class='col-xs-8 col-xs-offset-2'>
  <%= form_with url: publish_parse_match_path, local: true, method: :post do |form| %>

    <%= hidden_field_tag 'id', "#{@data_product.id}" %>

    <%= hidden_field_tag 'hdu_index', id: 'hdu_index' %>

    <div id='column_set'>
      <p><h3>Column</h3></p>

      <div class='form-group'>
        <%= label_tag :identifier %><br />
        <%= select_tag 'identifier[]', options_for_select(@columns), { id: "identifier-1", onchange: "identifier_selected(this.id)", class: "form-control" } %>
      </div>
      <div class='form-group'>
        <%= label_tag :name %><br />
        <%= text_field_tag 'name[]', nil, id: "name-1", class: 'form-control', placeholder: 'A name for this column' %>
      </div>
      <div class='form-group'>
        <%= label_tag :description %><br />
        <%= text_field_tag 'description[]', nil, class: 'form-control', placeholder: 'A description for this column' %>
      </div>
      <div class='form-group'>
        <%= label_tag :type %><br />
        <%= select_tag 'type_alt[]', options_for_select(@types.map { |s| [s.strip] }), class: "form-control" %>
      </div>
      <div class='form-group'>
        <%= label_tag :verb_level %><br />
        <%= select_tag 'verb_level[]', options_for_select(1..30), class: 'form-control' %>
      </div>
      <div class='form-group'>
        <%= label_tag :unit %> <a id="manual_unit-1" href="#" onclick="replace_manual_unit(this.id);return false;">(or manually write the unit)</a> <br />
        <%= select_tag 'unit[]', options_for_select(@units), { id: "unit-1", class: "form-control" } %>
      </div>
      <div class='form-group'>
        <%= label_tag :UCDs, 'UCDs' %> <a id="manual_ucd-1" href="#" onclick="replace_manual_ucd(this.id);return false;">(or manually write the UCDs)</a> <br />
        <%= select_tag 'ucds[]', options_for_select(@ucds), { id: "ucds-1", class: "form-control" } %>
      </div>
      <div class='form-group'>
        <%= label_tag :required, 'Is this column required?' %><br />
        <%= select_tag 'required[]', options_for_select([['Yes', true], ['No', false]]), class: 'form-control' %>
      </div>

      <hr />
    </div>

    <a href="javascript:;" id="addNewColumn">Add New Column</a>

    <div class='actions'>
      <br /><%= form.submit %>
    </div>
  <% end %>

  <div class="hide" id="new_column_form">
    <%= render partial: "column", locals: { skill: false } %>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function() {
    var columns_number = 2

    columns = <%= raw @columns.to_json %>
    
    raw_units = <%= raw @raw_units.to_json %>
    raw_ucds = <%= raw @raw_ucds.to_json %>

    unit_html = document.getElementById("unit-tmp").outerHTML
    ucds_html = document.getElementById("ucds-tmp").outerHTML

    $("#addNewColumn").click(function() {
      $("#column_set").append($("#new_column_form").html())

      document.getElementById("identifier-tmp").setAttribute("id", "identifier-" + columns_number.toString())
      document.getElementById("name-tmp").setAttribute("id", "name-" + columns_number.toString())
      document.getElementById("unit-tmp").setAttribute("id", "unit-" + columns_number.toString())
      document.getElementById("manual_unit-tmp").setAttribute("id", "manual_unit-" + columns_number.toString())
      document.getElementById("ucds-tmp").setAttribute("id", "ucds-" + columns_number.toString())
      document.getElementById("manual_ucd-tmp").setAttribute("id", "manual_ucd-" + columns_number.toString())

      columns_number++
    })
  })

  function identifier_selected(id) {
    var column = id.split("-")

    var column_index = parseInt(column[column.length - 1])
    var selected_index = document.getElementById(id).selectedIndex

    identifier = columns[selected_index]

    document.getElementById(`name-${column_index}`).value = identifier.toLowerCase()

    if (raw_units[selected_index - 1]) {
      $(`#unit-${column_index}`).replaceWith(unit_html.replace('unit-tmp', `unit-${column_index}`))

      document.getElementById(`unit-${column_index}`).value = raw_units[selected_index - 1]
    } else
      $(`#unit-${column_index}`).replaceWith(`<input type='text' name='unit[]'' id='unit-${column_index}' class='form-control' />`)

    if (raw_ucds[selected_index - 1]) {
      $(`#ucds-${column_index}`).replaceWith(ucds_html.replace('ucds-tmp', `ucds-${column_index}`))

      document.getElementById(`ucds-${column_index}`).value = raw_ucds[selected_index - 1]
    }
    else
      $(`#ucds-${column_index}`).replaceWith(`<input type='text' name='ucds[]'' id='ucds-${column_index}' class='form-control' />`)
  }

  function replace_manual_unit(id) {
    var column = id.split("-")

    var column_index = parseInt(column[column.length - 1])

    $(`#unit-${column_index}`).replaceWith(`<input type='text' name='unit[]'' id='unit-${column_index}' class='form-control' />`)
  }

  function replace_manual_ucd(id) {
    var column = id.split("-")

    var column_index = parseInt(column[column.length - 1])

    $(`#ucds-${column_index}`).replaceWith(`<input type='text' name='ucds[]'' id='ucds-${column_index}' class='form-control' />`)
  }
</script>